üíä PharmaPlus Database - SQL Stored Procedures & Functions

Task: Task 8 - Stored Procedures & Functions
Database: PharmaPlus

üìÑ Project Overview

This SQL script initializes a set of 10 database routines (5 Stored Procedures and 5 Functions) for the PharmaPlus database. These routines are designed to encapsulate common business logic, such as calculating sales metrics, retrieving order information, and updating product data.

The script is idempotent, meaning it can be run multiple times safely. It first drops any existing routines with the same name before creating the new versions.

‚öôÔ∏è Core Script Logic

The script performs the following actions in order:

Selects Database: Sets the default database to USE PharmaPlus;.

Cleanup: Drops all 10 procedures and functions if they already exist to ensure a clean rebuild.

Procedure Creation: Creates 5 stored procedures for common operations (e.g., getting sales by rep, updating prices).

Function Creation: Creates 5 functions for specific calculations (e.g., total revenue, average order value).

Examples: Provides 30 example CALL and SELECT statements to demonstrate and test the functionality of every created routine.

üìö Implemented Routines

Stored Procedures

Procedure

IN Parameters

OUT Parameters

Description

sp_TotalSalesByRep

p_rep_id INT

(None)

Returns total sales for a single, specified sales rep.

sp_UpdateProductPrice

p_product_id INT 



 p_new_price DECIMAL(10,2)

p_old_price DECIMAL(10,2)

Updates a product's price and returns the old price.

sp_OrdersByCustomer

p_customer_id INT

(None)

Lists all orders for a specific customer, sorted by date.

sp_SalesByManufacturer

p_manufacturer_id INT

(None)

Calculates total sales revenue for a specific manufacturer.

sp_SalesSummaryByRegion

(None)

(None)

Returns a summary of total sales, grouped by sales rep region.

Functions

Function

Parameters

Returns

Description

fn_TotalRevenue

(None)

DECIMAL(12,2)

Returns the grand total revenue from all SalesOrders.

fn_RevenueByRep

p_rep INT

DECIMAL(12,2)

Returns the total revenue generated by a specific sales rep.

fn_AvgOrderValue

(None)

DECIMAL(10,2)

Returns the average total_amount across all SalesOrders.

fn_ProductRevenue

p_product INT

DECIMAL(12,2)

Returns the total revenue for a specific product from OrderItems.

fn_OrderItemTotal

p_order_item INT

DECIMAL(10,2)

Returns the calculated line total (quantity * unit_price) for a single order item.

üóÉÔ∏è Database Schema Context

These routines primarily interact with the core sales and product tables. Understanding their relationships is key to understanding the JOIN logic within the code.

SalesReps is linked to SalesOrders (One-to-Many).

Customers is linked to SalesOrders (One-to-Many).

SalesOrders is linked to OrderItems (One-to-Many).

Products is linked to OrderItems (One-to-Many).

Manufacturers is linked to Products (One-to-Many).

üöÄ How to Use

Connect to your MySQL server using a client like MySQL Workbench.

Ensure the PharmaPlus database exists and is populated with the relevant tables (SalesOrders, SalesReps, Products, Customers, Manufacturers, OrderItems).

Open and execute this entire SQL script. This will drop any old versions and create all 10 routines.

You can now use the CALL and SELECT statements (as shown in the examples) in any query window.

üí° Example Usage

Here is a small selection of the 30 test queries included in the file.

-- 1. Get total sales for rep 104
CALL sp_TotalSalesByRep(104);

-- 2. List all orders placed by customer 1001
CALL sp_OrdersByCustomer(1001);

-- 3. Update product 1's price and capture the old price
CALL sp_UpdateProductPrice(1, 55.00, @old_price1);
SELECT @old_price1 AS old_price_before_update;

-- 4. Get a summary of sales by region
CALL sp_SalesSummaryByRegion();

-- 5. Get total database revenue
SELECT fn_TotalRevenue() AS total_revenue;

-- 6. Get revenue for rep 103
SELECT fn_RevenueByRep(103) AS revenue_rep103;

-- 7. Find the product with the highest revenue
SELECT product_id, fn_ProductRevenue(product_id) AS total_rev
FROM Products
ORDER BY total_rev DESC
LIMIT 1;

-- 8. Get a final summary report
SELECT fn_TotalRevenue() AS total_rev, fn_AvgOrderValue() AS avg_val;


‚úÖ Full 30-Example Test Script

<details>
<summary>Click to expand and see all 30 test examples</summary>

-- 1. Total sales for rep 104
CALL sp_TotalSalesByRep(104);

-- 2. Total sales for rep 102
CALL sp_TotalSalesByRep(102);

-- 3. Update product price for Product 1
CALL sp_UpdateProductPrice(1, 55.00, @old_price1);
SELECT @old_price1 AS old_price_before_update;

-- 4. List all orders placed by customer 1001
CALL sp_OrdersByCustomer(1001);

-- 5. Orders for customer 1003
CALL sp_OrdersByCustomer(1003);

-- 6. Sales by manufacturer 1 (MediGen)
CALL sp_SalesByManufacturer(1);

-- 7. Sales by manufacturer 2 (PharmaCore)
CALL sp_SalesByManufacturer(2);

-- 8. Region-wise sales summary
CALL sp_SalesSummaryByRegion();

-- 9. Total revenue (function)
SELECT fn_TotalRevenue() AS total_revenue;

-- 10. Revenue by rep 103
SELECT fn_RevenueByRep(103) AS revenue_rep103;

-- 11. Average order value
SELECT fn_AvgOrderValue() AS avg_order_value;

-- 12. Product 2 revenue (Amoxicillin)
SELECT fn_ProductRevenue(2) AS product2_revenue;

-- 13. Product 8 revenue (Vitamin C)
SELECT fn_ProductRevenue(8) AS product8_revenue;

-- 14. Order item 1 total value
SELECT fn_OrderItemTotal(1) AS order_item1_total;

-- 15. Order item 5 total
SELECT fn_OrderItemTotal(5) AS order_item5_total;

-- 16. Compare rep 104 vs 102 revenue
SELECT fn_RevenueByRep(104) AS rep104_rev, fn_RevenueByRep(102) AS rep102_rev;

-- 17. Display customer orders with total
CALL sp_OrdersByCustomer(1002);

-- 18. Use function result in condition
SELECT IF(fn_TotalRevenue() > 200000, 'High', 'Low') AS sales_status;

-- 19. Find top product sales using function
SELECT product_id, fn_ProductRevenue(product_id) AS total_rev FROM Products ORDER BY total_rev DESC;

-- 20. Use OUT proc to update and verify new price
CALL sp_UpdateProductPrice(5, 75.00, @old_price5);
SELECT @old_price5 AS old_price_before_update;

-- 21. Check rep 105 total sales via proc
CALL sp_TotalSalesByRep(105);

-- 22. Validate total revenue from SalesOrders = fn_TotalRevenue
SELECT SUM(total_amount) AS manual_total, fn_TotalRevenue() AS func_total FROM SalesOrders;

-- 23. Region summary for performance comparison
CALL sp_SalesSummaryByRegion();

-- 24. Get rep with max revenue
SELECT rep_id, fn_RevenueByRep(rep_id) AS revenue FROM SalesReps ORDER BY revenue DESC LIMIT 1;

-- 25. Highest revenue product
SELECT product_id, fn_ProductRevenue(product_id) AS revenue FROM Products ORDER BY revenue DESC LIMIT 1;

-- 26. Revenue check per manufacturer 3
CALL sp_SalesByManufacturer(3);

-- 27. Use function in WHERE clause
SELECT product_name, fn_ProductRevenue(product_id) AS revenue
FROM Products WHERE fn_ProductRevenue(product_id) > 10000;

-- 28. Loop testing: Annual simulation (rep 102)
CALL sp_TotalSalesByRep(102);

-- 29. Quick check for avg order
SELECT fn_AvgOrderValue() AS avg_order;

-- 30. Final report combining functions
SELECT fn_TotalRevenue() AS total_rev, fn_AvgOrderValue() AS avg_val;


</details>
